<font size="4">

# JVM入门

by 菲尼莫斯 2019年3月18日

---

## 基本

* jdk是java的开发工具包，包含了java编译器，可以将.java文件编译为.class字节码文件，以及一些其他的开发工具（如 web server）

* jre是java的运行环境，jdk中包含了jre，是执行java必须的一部分，包含jvm、基本类库、配置和java的执行命令等

* jvm是java运行时所存在的环境，是为java语言深度优化的虚拟硬件模拟软件，拥有处理器、指令系统、堆栈和寄存器

## 类加载的过程

类的加载：JVM把class文件加载到内存，对数据进行校验、解析和初始化，最终形成JVM可以直接使用的类型

1. 加载：使用类加载器将字节码的内容加载到内存中
    * 将静态的数据转换为**运行时数据**存入JVM内存的**方法区**（方法区位于堆中）
    * 运行时数据包括：静态变量（域）、静态方法、类代码、常量池（方法名、参数类型、变量名等，不是指final常量）
    * 在堆中生成一个该类Class对象，作为方法区数据的访问接口
    * 字节码的来源可以是.class文件、jar包或者其他方式读取

2. 连接：将类的字节码合并到JVM的运行时状态中
    * 验证：确保类符合JVM规范，语法正确，没有安全问题
    * 准备：为类（静态）变量的数据分配内存并设置为默认值（**0，或者null**）并存入**方法区**
    * 解析：将JVM内存常量池的符号引用替换为直接引用，包括类名、变量名、字面量等。
    * （解析：即将源码中的字面量符号替换成引用的对象，如`int a = 22`变换为`int类引用信息地址 a变量名引用地址 = 22字面量引用地址`）

3. 初始化：执行类构造器`<clinit>()`方法
   * 类构造器方法是**编译器**收集并合并类中**静态变量**的赋值和**static代码**块所产生的初始化方法，该方法生成到.class中
   * 若父类没有初始化，则会**先对父类进行初始化**
   * 类构造器方法无法自己定义，是编译器自动产生并由JVM调用的，该方法是一个静态方法，保存在方法区中
   * 该方法是线程安全的
   * 对于一个类的静态变量或函数，第一次引用到该静态属性时便会初始化该类
   * **常量和其他非静态变量是在new一个对象时进行初始化的**

4. 卸载

## 其他

* 每个java程序使用一个java虚拟机

* 虚拟机的运行开始于main()方法，为程序的初始线程且不为守护线程

* 在对应权限下调用exit()方法能够终止程序执行

* 类加载子系统（class loader）负责加载类和接口
    * 类和接口是在第一次使用的时候被动态加载进JVM的，如创建了一个对该类静态成员的引用

* 执行引擎（execution engine）负责执行加载类中的指令

* 内存分配
    * 线程共享区：方法区（常量、静态变量、类信息、.class字节码）、堆（存储对象实例）
    * 线程私有：虚拟机栈（类的方法调用）、本地方法栈（非java方法调用）、程序计数器（行数）

* 类的加载和链接是在运行时进行的：loading（运行时数据结构）、verification（规范、版本、安全等）、preparation（分配内存、常量初始化）、resolution（符号引用转为直接引用）、initialization（类变量）、using（主被动引用）、unloading（卸载）

</font>
