---
title: spring事务管理
author: 菲尼莫斯
date: 2019-05-09
tags:
- spring
categories:
- java
---

# spring事务管理

by 菲尼莫斯 2019年5月9日

---

## 基础

**事务：**指一组操作的集合，要么所有操作都成功，要么都失败

**原子性：**事务是不可分割的，其中的任何操作不能独立运行，所有操作要么全都执行，要么全都不执行

**一致性：**事务运行前后，数据完整保持一致，数据约束不被破坏（如转账100，必须收到100）

**隔离性：**意味着事务必须在不干扰其他进程或事务的前提下独立执行
* 脏读：一个事务读取到了另一个事务改写但未提交的数据
* 不可重复度：一个事务重复读取同一数据时返回了不一样的值
* 幻读：一个事务读取多条数据后，另一个事务又插入了几条数据，导致前一个数据的操作不完全

**持久性：**事务一旦被提交，其产生的变化将是永久的，无法因为故障等因素影响

## 核心接口

**PlatformTransactionManager**：平台事务管理器，包括事务获取、提交和回滚
* 根据持久层框架，通常有官方的实现类（如spring-jdbc和mybatis使用的DataSourceTransactionManager）

**TransactionDefinition**：事务定义信息，包括事务**隔离级别，传播行为，超时信息，只读**等

隔离级别：
* DEFAULT，即和数据库的隔离性保持一致，可以满足基本的隔离性需求
* READ_COMMITTED，可以防止脏读，但不能满足幻读和不可重复读（Oracle）
* REPEATABLE_READ，可以防止脏读、不可重复读，但不能满足幻读（MYSQL）
* SERIALIZABLE，以队列来运行事务，从而具备最强的隔离性

传播行为：用于解决业务层中多个事务间的传递问题，以同时运行业务A和业务B为例
* REQUIRED(保证所有业务在一个事务中)，支持当前事务，如果事务不存在则创建一个（若A中已存在事务，则B对其进行沿用，否则创建一个）
* REQUIRES_NEW（保证所有业务在不同事务中），如果有事务存在则挂起当前事务，新建一个事务（若A中已存在事务，则B将A的事务挂起，自己新建一个事务）
* NESTED，如果当前事务存在，则嵌套执行事务（A和B即可嵌套为一个事务，又可以设置保存点进行回滚）

**TransactionStatus**：事务状态，事务是否有保存点、是否已完成、是否rollback-only等

## 使用AOP来进行事务管理

